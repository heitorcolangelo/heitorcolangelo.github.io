---
title: Testes no Android com Espresso — parte 3
date: 2016-08-10 00:00:00 Z
tags:
- android
- espresso
- software-testing
layout: post
---

<h4>Testando intents.</h4><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*99qTbnhUu3jQsGn3eWIgrA.png" /></figure><p>No <a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-2-5180ee03ed9a#.7hwn7r3fe">post anterior</a> fizemos nosso primeiro teste na tela de Login. Caso queira iniciar a partir deste post, utilize o branch ‘<a href="https://github.com/heitorcolangelo/EspressoTests/tree/part_2">part_2</a>’ do projeto.</p><p><strong>Simulando resultados de intents.</strong></p><p>Vamos escrever o teste para o seguinte cenário:</p><ul><li>Quando <em>username </em>e <em>password </em>não são vazios e o usuário clica no botão de login, o app deve abrir a tela principal (MainActivity).</li></ul><p>Poderíamos escrever um teste que preencha os dois campos, clique no botão de login e em seguida verifique se o layout da MainActivity estará visível, algo deste tipo:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/c05dc3276e208f000d4184c8df6b695d/href">https://medium.com/media/c05dc3276e208f000d4184c8df6b695d/href</a></iframe><p>Porém, isso é errado por dois motivos. O primeiro pode ser considerado mais uma dica:</p><blockquote><strong>Evite fazer testes que façam navegações através do app, inicie as activities diretamente no estado desejado.</strong></blockquote><p>O segundo motivo é que a MainActivity faz uma requisição para a API, o que torna este teste dependente de um recurso externo. E aí vai outra dica, que na verdade, deve ser uma <strong>regra</strong>:</p><blockquote><strong>Os testes devem ser isolados de qualquer dependência externa.</strong></blockquote><p>Para testarmos se uma <em>activity</em> é iniciada, devemos testar se a <em>intent</em> desta <em>activity</em> é lançada, afinal de contas, quem define qual <em>activity</em> será iniciada é a <em>intent</em>. Para podermos validar a <em>intent</em>, devemos adicionar a seguinte dependência no nosso arquivo <em>build.gradle</em>:</p><pre>androidTestCompile &quot;com.android.support.test.espresso:espresso-intents:$espressoVersion&quot;</pre><p>Essa é uma extensão do Espresso que nos permite trabalhar com intents (mais informações neste <a href="https://google.github.io/android-testing-support-library/docs/espresso/intents/">link</a>).</p><p>Antes de escrevermos o teste, vamos analisar o trecho do código que inicia a nossa MainActivity (LoginActivity.java, linha 53).</p><pre>private void doLogin() {<br>  startActivity(new Intent(this, MainActivity.class));<br>}</pre><p>A <em>intent</em> que estamos montando é bem simples, possui apenas o nome da classe (MainActivity.class) e o contexto como parâmetros. Vamos utilizar o nome da classe para validar nossa <em>intent</em>. O nosso teste ficará assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/e4f6cc8cc20a00dee0c426d6e14d4223/href">https://medium.com/media/e4f6cc8cc20a00dee0c426d6e14d4223/href</a></iframe><p>Vamos analisar o código:</p><ul><li>Linha 3: Estamos iniciando a gravação das intents com o método <a href="https://developer.android.com/reference/android/support/test/espresso/intent/Intents.html#init()"><em>init()</em></a><em>;</em></li><li>Linhas 5 e 6: Nada de novo, apenas preenchendo os campos <em>username </em>e <em>password;</em></li><li>Linha 8: Usamos o método <em>IntentMatchers.</em><a href="https://developer.android.com/reference/android/support/test/espresso/intent/matcher/IntentMatchers.html#hasComponent(java.lang.String)"><em>hasComponent</em></a><em>(String className)</em> passando como parâmetro o nome da classe MainActivity, que é a <em>activity</em> que será iniciada;</li><li>Linha 10: Fazemos o click no botão de login;</li><li>Linha 12: O método <a href="https://developer.android.com/reference/android/support/test/espresso/intent/Intents.html#intended(org.hamcrest.Matcher&lt;android.content.Intent&gt;)"><em>intended(Matcher&lt;Intent&gt; matcher)</em></a> verifica que o <em>matcher</em> passado como parâmetro é o que a activity em teste irá lançar, garantindo também que esta intent seja única;</li><li>Linha 14: O método <a href="https://developer.android.com/reference/android/support/test/espresso/intent/Intents.html#release()"><em>release()</em></a><em> </em>limpa os estados das intents.</li></ul><p>O que estamos fazendo é falar para o Espresso: “<em>Cara, quando eu preencher estes dois campos e clicar no botão de login, o app deve lançar uma intent para abrir a MainActivity.”.</em> Simples assim.</p><p>Se rodarmos o teste, ele passa. Porém ainda há algo errado nele. Repare que a MainActivity ainda abre. E faz sentido, afinal de contas, a única coisa que fizemos foi garantir que a intent lançada é a correta, não fizemos nada para impedir que a MainActivity se inicie.</p><p>Para garantir que o nosso teste esteja isolado e evitar a navegação pelo app, vamos simular o resultado desta intent. Refatorando o teste, vai ficar assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/302ae6368bbac2156e4f80f17946d4c9/href">https://medium.com/media/302ae6368bbac2156e4f80f17946d4c9/href</a></iframe><p>Foram adicionadas duas linhas:</p><ul><li>Linha 8: Estamos criando um objeto <a href="https://developer.android.com/reference/android/app/Instrumentation.ActivityResult.html"><em>ActivityResult</em></a> que irá simular o resultado da activity;</li><li>Linha 9: Usamos o método <a href="https://developer.android.com/reference/android/support/test/espresso/intent/Intents.html#intending(org.hamcrest.Matcher&lt;android.content.Intent&gt;)"><em>intending()</em></a> para devolver um resultado assim que a intent for lançada.</li></ul><p>Um ponto importante na documentação do Espresso sobre esse método:</p><pre><strong>Note:</strong> the destination activity will not be launched.</pre><ul><li>Linha 9: Chamamos o método <a href="https://developer.android.com/reference/android/support/test/espresso/intent/OngoingStubbing.html#respondWith(android.app.Instrumentation.ActivityResult)"><em>respondWith()</em></a><em>, </em>passando como parâmetro o nosso objeto ActivityResult definido na linha 8.</li></ul><p>Novamente, o que estamos falando para o Espresso é: <em>“Quando esta intent for lançada, responda com esse resultado.”</em>, evitando que a MainActivity inicie.</p><p>Rode o teste, ele deve passar sem problemas e a MainActivity não será iniciada. Se algo deu errado, retome os passos anteriores ou deixe um comentário abaixo para eu poder te ajudar.</p><p>Ótimo, agora que já cobrimos nossa primeira tela com testes, podemos seguir em frente. Antes, verifique se o seu código está parecido com o que está na branch ‘part_3’ do <a href="https://github.com/heitorcolangelo/EspressoTests">repositório</a>.</p><p>Se tiver alguma dúvida, sugestão, ou se encontrou um erro no post, deixe um comentário.</p><p><a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-4-6107e3e023bc#.2zuajz688">Ir para Parte 4 — mockando requisições para a API &gt;&gt;</a></p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=b1d690e7bcc8" width="1" height="1" alt="">
