---
layout: post
title: Testes no Android com Espresso â€” parte 6
tag:
- android
- teste
- espresso
---

<h4>Custom matchers e runtime permissions</h4><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*99qTbnhUu3jQsGn3eWIgrA.png" /></figure><p>No <a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-5-9df6dade067e#.waflm9hf2">post anterior</a> aprendemos como fazer asserÃ§Ãµes e interaÃ§Ãµes em uma <em>recyclerview</em>. Caso queira iniciar a partir deste post, utilize o branch â€˜part_5â€™ doÂ projeto.</p><p>Nesta parte do tutorial, vamos ver como fazer um <em>matcher </em>customizado e aprender a tratar as runtime permissions. Para isso, foi necessÃ¡rio fazer uma alteraÃ§Ã£o no projeto inicial. Confira esta alteraÃ§Ã£o na classe <em>ImageAndTextView.java(linha 47)</em> e na classe <em>UserDetailsActivity</em>. Entenda bem esta alteraÃ§Ã£o antes de prosseguir.</p><h4>Primeiro cenÃ¡rio</h4><p>A UserDetailsActivity possui o seguinteÂ layout:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/348/1*2E5Ck9MdFOVgEHsr6LvHcw.png" /><figcaption>UserDetailsActivity.java</figcaption></figure><p>Temos a foto do usuÃ¡rio, o nome, telefone, e-mail e endereÃ§o. Este pode ser o primeiro cenÃ¡rio: verificar se todas as informaÃ§Ãµes aparecem na tela. Como Ã© um cenÃ¡rio simples, vou deixar como tarefa para vocÃª implementar.</p><h4>Segundo cenÃ¡rio</h4><p>Com exceÃ§Ã£o do nome, o usuÃ¡rio nem sempre terÃ¡ todos estes dados e, caso ele nÃ£o tenha telefone, e-mail ou endereÃ§o, a mensagem â€œ<em>No info available.</em>â€ deve aparecer, em vermelho. Conforme imagemÂ abaixo:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/342/1*ogfkyvm6gtxJeFm-mO3rwA.png" /><figcaption>UsuÃ¡rio semÂ e-mail.</figcaption></figure><p>EntÃ£o, um outro cenÃ¡rio Ã©: verificar se o texto <em>â€œNo info available.â€ </em>aparece quando o usuÃ¡rio nÃ£o possui e-mail, telefone ou endereÃ§o.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/338c0f5147a962fd8945fc75b66c7f8b/href">https://medium.com/media/338c0f5147a962fd8945fc75b66c7f8b/href</a></iframe><p>Nada de novo neste teste, apenas iniciando a UserDetailsActivity com uma intent que contÃ©m um usuÃ¡rio sem e-mail (Mocks.USER_MISSING_INFO) e verificando se o texto <em>â€œNo info available.â€ </em>estÃ¡ visÃ­vel. PorÃ©m, nÃ£o testamos se a cor do texto Ã© vermelha. Para fazer isso, vamos criar um <em>customÂ matcher.</em></p><p>Crie um pacote <em>matcher</em> e uma classe <em>TextColorMatcher</em>, conforme imagemÂ abaixo:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/460/1*zdJgqgZPFJeCMUWlD8kHgA.png" /></figure><p>A classe <em>TextColorMatcher</em> ficarÃ¡Â assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/7b69b5e9f957513fb7c8b64be7804513/href">https://medium.com/media/7b69b5e9f957513fb7c8b64be7804513/href</a></iframe><ul><li>Linha 5: declaramos o mÃ©todo <em>withTextColor </em>que recebe uma cor como parÃ¢metro e retorna um <em>Matcher&lt;View&gt;.</em></li><li>Linha 6: criamos uma nova instÃ¢ncia da classe <a href="https://developer.android.com/reference/android/support/test/espresso/matcher/BoundedMatcher.html">BoundedMatcher</a>, que permitirÃ¡ a criaÃ§Ã£o do nosso <em>viewÂ matcher.</em></li><li>Linha 7: inicializamos a variÃ¡vel que vai armazenar o valor atual da cor do texto do nosso textview.</li><li>Linhas 8 Ã  13: sobrescrevemos o mÃ©todo <em>describeTo.</em> Ã‰ neste mÃ©todo que iremos atribuir ao objeto, do tipo <em>Description,</em> aquilo que serÃ¡ exibido no log caso a asserÃ§Ã£oÂ falhe.</li><li>Linhas 16 Ã  21: sobrescrevemos o mÃ©todo <em>matchesSafely, </em>que Ã© onde faremos a comparaÃ§Ã£o entre a cor atual do TextView, e a cor que esperamos que eleÂ tenha.</li></ul><p>Agora Ã© sÃ³ usarmos o nosso custom matcher noÂ teste:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/47f649fa002b6fa7533f5958357872ed/href">https://medium.com/media/47f649fa002b6fa7533f5958357872ed/href</a></iframe><p>Para garantir que estÃ¡ funcionando, tente passar uma cor diferente para verificar se o teste falha. Verifique tambÃ©m se a mensagem de erro Ã© a que foi configurada no nosso <em>custom</em>Â <em>matcher</em>.</p><pre><strong>NoMatchingViewException</strong>: No views in hierarchy found matching: (with text: is â€œNo info available.â€ and <strong>expected TextColor:</strong> â€œffff4081â€ <strong>current TextColor:</strong> â€œfff44336â€)</pre><p>Outro detalhe desta tela Ã© que cada informaÃ§Ã£o executa uma aÃ§Ã£o quandoÂ clicada:</p><ul><li>No nÃºmero do telefone, uma ligaÃ§Ã£o Ã©Â feita;</li><li>No e-mail, uma nova mensagem Ã© aberta para ser enviada aoÂ usuÃ¡rio;</li><li>No endereÃ§o, o Google Maps Ã© aberto e Ã© possÃ­vel traÃ§ar umaÂ rota.</li></ul><p>Vamos escrever o teste para o clique no telefone. Os outros dois testes deixo para vocÃª implementar.</p><h4>Runtime Permissions</h4><p>A partir do Android 6, as permissÃµes sÃ£o solicitadas em tempo de execuÃ§Ã£o. Isso afeta os nossos testes, pois temos que fazer um tratamento especial para este tipo de situaÃ§Ã£o.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/368/1*sZcT-X15p5IMl4D75ulCsg.png" /><figcaption>PermissÃ£o para fazerÂ ligaÃ§Ã£o</figcaption></figure><p>Por exemplo, teremos problemas se executarmos um teste comoÂ esse:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/bd11bd3f96168ba8d13ef898c7be8a67/href">https://medium.com/media/bd11bd3f96168ba8d13ef898c7be8a67/href</a></iframe><p>Em devices anteriores ao Android 6 este teste passa, mas em devices com versÃ£o Marshmallow em diante, ele vaiÂ falhar.</p><p>TambÃ©m nÃ£o conseguimos fazer o Espresso clicar no botÃ£o â€œAllowâ€, pois este <em>dialog</em> estÃ¡ fora do contexto da aplicaÃ§Ã£o.</p><p>Para este tipo de interaÃ§Ã£o, vamos usar o <a href="https://developer.android.com/topic/libraries/testing-support-library/index.html#UIAutomator">UiAutomator</a>, pois ele nos permite executar interaÃ§Ãµes com apps do Android. Se vocÃª quiser saber melhor a diferenÃ§a entre Espresso e UiAutomator, dÃª uma olhada <a href="http://stackoverflow.com/questions/31076228/android-testing-uiautomator-vs-espresso">nesta discussÃ£o</a> no stackoverflow.</p><p>Para comeÃ§ar, adicione esta configuraÃ§Ã£o no seu arquivo build.gradle:</p><pre>// UiAutomator<br>androidTestCompile &quot;com.android.support.test.uiautomator:uiautomator-v18:2.1.2&quot;</pre><p>Sincronize o projeto, vocÃª provavelmente verÃ¡ esteÂ erro:</p><pre>Manifest merger failed : <br><strong>uses-sdk:minSdkVersion 16 cannot be smaller than version 18 declared in library ... uiautomator-v18:2.1.2<br></strong>...<br><strong>Suggestion: <br>use tools:overrideLibrary=â€android.support.test.uiautomator.v18&quot; to force usage</strong></pre><p>Para solucionar este problema, Ã© sÃ³ seguir a sugestÃ£o do prÃ³prio log de erro: <em>â€œuse tools:overrideLibrary=â€android.support.test.uiautomator.v18 to forceÂ usage&quot;.</em></p><p>Primeiro, crie um novo arquivo <em>AndroidManifest.xml </em>dentro da sua pasta <em>androidTest:</em></p><figure><img alt="" src="https://cdn-images-1.medium.com/max/284/1*EDfoMAUtgkpu1PHfeSuHvw.png" /><figcaption>Novo AndroidManifest.xml</figcaption></figure><p>Dentro deste arquivo, coloque o cÃ³digoÂ abaixo:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/e5be08b45257617a7c30b38a12051f22/href">https://medium.com/media/e5be08b45257617a7c30b38a12051f22/href</a></iframe><p>Quando ocorrer o merge do Manifest, o erro nÃ£o ocorrerÃ¡ novamente.</p><p>Eu peguei essa dica <a href="http://stackoverflow.com/a/31880936/3279958">desta resposta</a> no stackoverflow. O que acontece Ã© que a lib do UiAutomator tem minSdk 18, e o nosso app tem minSdk 16. Mas como vamos utilizar o UiAutomator somente para os testes, nÃ£o tem problema sobrescrevermos este valor no Manifest. Fiz os testes com essa alteraÃ§Ã£o em emuladores com API 16+ e tudo funcionou normalmente.</p><p>Seguindo com nosso teste, temos o UiAutomator configurado corretamente. Vamos utilizÃ¡-lo para interagir com o dialog de permissÃ£o doÂ Android.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/c464d213c97b4e124e90b5bf90e1c7bd/href">https://medium.com/media/c464d213c97b4e124e90b5bf90e1c7bd/href</a></iframe><p>Esta classe eu encontrei <a href="https://gist.github.com/rocboronat/65b1187a9fca9eabfebb5121d818a3c4">neste gist</a>. Vamos analisÃ¡-la porÂ partes:</p><ul><li>Linha 11: Verificamos se a versÃ£o do Android Ã© 6 ou mais, e se a permissÃ£o que precisamos ainda nÃ£o foiÂ dada.</li><li>Linha 13: Recuperamos a instÃ¢ncia singleton da class <a href="https://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html">UiDevice</a>. Isto permitirÃ¡ a interaÃ§Ã£o com o dispositivo.</li><li>Linha 14 atÃ© 17: Procuramos pelo botÃ£o â€œAllowâ€ do dialog de permissÃ£o. Para isso, criamos um objeto <a href="https://developer.android.com/reference/android/support/test/uiautomator/UiSelector.html">UiSelector</a> e chamamos alguns mÃ©todos do <em>builder</em> desta classe para configurar nosso objeto. Um destes mÃ©todos Ã© o <em>index(int index). </em>Este mÃ©todo vai definir o ID do botÃ£o que queremos clicar. No caso do dialog, o botÃ£o â€œAllowâ€ tem valor 1. Se quisÃ©ssemos clicar no â€œDenyâ€ usarÃ­amos o index =Â 0.</li><li>Linha 18 e 19: Se o botÃ£o â€œAllowâ€ foi encontrado, efetuamos um cliqueÂ nele.</li></ul><p>No nosso teste, vamos chamar o mÃ©todo <em>allowPermissionsIfNeeded </em>do <em>PermissionUtils </em>logo depois do clique no telefone. FicarÃ¡Â assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/5e051de61a05d237f78d640e449d5e84/href">https://medium.com/media/5e051de61a05d237f78d640e449d5e84/href</a></iframe><p>Tente executar o teste, verifique se ele passa. Se algo deu errado, retome os passos anteriores ou deixe um comentÃ¡rio para que eu possaÂ ajudar.</p><p>Existem outros cenÃ¡rios a serem testados nesta tela, mas o conhecimento necessÃ¡rio para isso jÃ¡ foi abordado neste tutorial. EntÃ£o, mÃ£os Ã  obra.Â ğŸ˜‰</p><p>Ao final desta etapa, seu cÃ³digo deve estar parecido com o da branch â€˜<a href="https://github.com/heitorcolangelo/EspressoTests/tree/part_6">part_6</a>â€™.</p><p><a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-7-dee47be84571#.d3ce90tjc">Ir para parte 7â€Šâ€”â€ŠDicas finais, TestButler e Robots Pattern&gt;&gt;.</a></p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=d53984b24dbb" width="1" height="1" alt="">
