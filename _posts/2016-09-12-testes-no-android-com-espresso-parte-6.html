---
layout: post
title: Testes no Android com Espresso — parte 6
tag:
- android
- teste
- espresso
---

<h4>Custom matchers e runtime permissions</h4><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*99qTbnhUu3jQsGn3eWIgrA.png" /></figure><p>No <a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-5-9df6dade067e#.waflm9hf2">post anterior</a> aprendemos como fazer asserções e interações em uma <em>recyclerview</em>. Caso queira iniciar a partir deste post, utilize o branch ‘part_5’ do projeto.</p><p>Nesta parte do tutorial, vamos ver como fazer um <em>matcher </em>customizado e aprender a tratar as runtime permissions. Para isso, foi necessário fazer uma alteração no projeto inicial. Confira esta alteração na classe <em>ImageAndTextView.java(linha 47)</em> e na classe <em>UserDetailsActivity</em>. Entenda bem esta alteração antes de prosseguir.</p><h4>Primeiro cenário</h4><p>A UserDetailsActivity possui o seguinte layout:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/348/1*2E5Ck9MdFOVgEHsr6LvHcw.png" /><figcaption>UserDetailsActivity.java</figcaption></figure><p>Temos a foto do usuário, o nome, telefone, e-mail e endereço. Este pode ser o primeiro cenário: verificar se todas as informações aparecem na tela. Como é um cenário simples, vou deixar como tarefa para você implementar.</p><h4>Segundo cenário</h4><p>Com exceção do nome, o usuário nem sempre terá todos estes dados e, caso ele não tenha telefone, e-mail ou endereço, a mensagem “<em>No info available.</em>” deve aparecer, em vermelho. Conforme imagem abaixo:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/342/1*ogfkyvm6gtxJeFm-mO3rwA.png" /><figcaption>Usuário sem e-mail.</figcaption></figure><p>Então, um outro cenário é: verificar se o texto <em>“No info available.” </em>aparece quando o usuário não possui e-mail, telefone ou endereço.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/338c0f5147a962fd8945fc75b66c7f8b/href">https://medium.com/media/338c0f5147a962fd8945fc75b66c7f8b/href</a></iframe><p>Nada de novo neste teste, apenas iniciando a UserDetailsActivity com uma intent que contém um usuário sem e-mail (Mocks.USER_MISSING_INFO) e verificando se o texto <em>“No info available.” </em>está visível. Porém, não testamos se a cor do texto é vermelha. Para fazer isso, vamos criar um <em>custom matcher.</em></p><p>Crie um pacote <em>matcher</em> e uma classe <em>TextColorMatcher</em>, conforme imagem abaixo:</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/460/1*zdJgqgZPFJeCMUWlD8kHgA.png" /></figure><p>A classe <em>TextColorMatcher</em> ficará assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/7b69b5e9f957513fb7c8b64be7804513/href">https://medium.com/media/7b69b5e9f957513fb7c8b64be7804513/href</a></iframe><ul><li>Linha 5: declaramos o método <em>withTextColor </em>que recebe uma cor como parâmetro e retorna um <em>Matcher&lt;View&gt;.</em></li><li>Linha 6: criamos uma nova instância da classe <a href="https://developer.android.com/reference/android/support/test/espresso/matcher/BoundedMatcher.html">BoundedMatcher</a>, que permitirá a criação do nosso <em>view matcher.</em></li><li>Linha 7: inicializamos a variável que vai armazenar o valor atual da cor do texto do nosso textview.</li><li>Linhas 8 à 13: sobrescrevemos o método <em>describeTo.</em> É neste método que iremos atribuir ao objeto, do tipo <em>Description,</em> aquilo que será exibido no log caso a asserção falhe.</li><li>Linhas 16 à 21: sobrescrevemos o método <em>matchesSafely, </em>que é onde faremos a comparação entre a cor atual do TextView, e a cor que esperamos que ele tenha.</li></ul><p>Agora é só usarmos o nosso custom matcher no teste:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/47f649fa002b6fa7533f5958357872ed/href">https://medium.com/media/47f649fa002b6fa7533f5958357872ed/href</a></iframe><p>Para garantir que está funcionando, tente passar uma cor diferente para verificar se o teste falha. Verifique também se a mensagem de erro é a que foi configurada no nosso <em>custom</em> <em>matcher</em>.</p><pre><strong>NoMatchingViewException</strong>: No views in hierarchy found matching: (with text: is “No info available.” and <strong>expected TextColor:</strong> “ffff4081” <strong>current TextColor:</strong> “fff44336”)</pre><p>Outro detalhe desta tela é que cada informação executa uma ação quando clicada:</p><ul><li>No número do telefone, uma ligação é feita;</li><li>No e-mail, uma nova mensagem é aberta para ser enviada ao usuário;</li><li>No endereço, o Google Maps é aberto e é possível traçar uma rota.</li></ul><p>Vamos escrever o teste para o clique no telefone. Os outros dois testes deixo para você implementar.</p><h4>Runtime Permissions</h4><p>A partir do Android 6, as permissões são solicitadas em tempo de execução. Isso afeta os nossos testes, pois temos que fazer um tratamento especial para este tipo de situação.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/368/1*sZcT-X15p5IMl4D75ulCsg.png" /><figcaption>Permissão para fazer ligação</figcaption></figure><p>Por exemplo, teremos problemas se executarmos um teste como esse:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/bd11bd3f96168ba8d13ef898c7be8a67/href">https://medium.com/media/bd11bd3f96168ba8d13ef898c7be8a67/href</a></iframe><p>Em devices anteriores ao Android 6 este teste passa, mas em devices com versão Marshmallow em diante, ele vai falhar.</p><p>Também não conseguimos fazer o Espresso clicar no botão “Allow”, pois este <em>dialog</em> está fora do contexto da aplicação.</p><p>Para este tipo de interação, vamos usar o <a href="https://developer.android.com/topic/libraries/testing-support-library/index.html#UIAutomator">UiAutomator</a>, pois ele nos permite executar interações com apps do Android. Se você quiser saber melhor a diferença entre Espresso e UiAutomator, dê uma olhada <a href="http://stackoverflow.com/questions/31076228/android-testing-uiautomator-vs-espresso">nesta discussão</a> no stackoverflow.</p><p>Para começar, adicione esta configuração no seu arquivo build.gradle:</p><pre>// UiAutomator<br>androidTestCompile &quot;com.android.support.test.uiautomator:uiautomator-v18:2.1.2&quot;</pre><p>Sincronize o projeto, você provavelmente verá este erro:</p><pre>Manifest merger failed : <br><strong>uses-sdk:minSdkVersion 16 cannot be smaller than version 18 declared in library ... uiautomator-v18:2.1.2<br></strong>...<br><strong>Suggestion: <br>use tools:overrideLibrary=”android.support.test.uiautomator.v18&quot; to force usage</strong></pre><p>Para solucionar este problema, é só seguir a sugestão do próprio log de erro: <em>“use tools:overrideLibrary=”android.support.test.uiautomator.v18 to force usage&quot;.</em></p><p>Primeiro, crie um novo arquivo <em>AndroidManifest.xml </em>dentro da sua pasta <em>androidTest:</em></p><figure><img alt="" src="https://cdn-images-1.medium.com/max/284/1*EDfoMAUtgkpu1PHfeSuHvw.png" /><figcaption>Novo AndroidManifest.xml</figcaption></figure><p>Dentro deste arquivo, coloque o código abaixo:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/e5be08b45257617a7c30b38a12051f22/href">https://medium.com/media/e5be08b45257617a7c30b38a12051f22/href</a></iframe><p>Quando ocorrer o merge do Manifest, o erro não ocorrerá novamente.</p><p>Eu peguei essa dica <a href="http://stackoverflow.com/a/31880936/3279958">desta resposta</a> no stackoverflow. O que acontece é que a lib do UiAutomator tem minSdk 18, e o nosso app tem minSdk 16. Mas como vamos utilizar o UiAutomator somente para os testes, não tem problema sobrescrevermos este valor no Manifest. Fiz os testes com essa alteração em emuladores com API 16+ e tudo funcionou normalmente.</p><p>Seguindo com nosso teste, temos o UiAutomator configurado corretamente. Vamos utilizá-lo para interagir com o dialog de permissão do Android.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/c464d213c97b4e124e90b5bf90e1c7bd/href">https://medium.com/media/c464d213c97b4e124e90b5bf90e1c7bd/href</a></iframe><p>Esta classe eu encontrei <a href="https://gist.github.com/rocboronat/65b1187a9fca9eabfebb5121d818a3c4">neste gist</a>. Vamos analisá-la por partes:</p><ul><li>Linha 11: Verificamos se a versão do Android é 6 ou mais, e se a permissão que precisamos ainda não foi dada.</li><li>Linha 13: Recuperamos a instância singleton da class <a href="https://developer.android.com/reference/android/support/test/uiautomator/UiDevice.html">UiDevice</a>. Isto permitirá a interação com o dispositivo.</li><li>Linha 14 até 17: Procuramos pelo botão “Allow” do dialog de permissão. Para isso, criamos um objeto <a href="https://developer.android.com/reference/android/support/test/uiautomator/UiSelector.html">UiSelector</a> e chamamos alguns métodos do <em>builder</em> desta classe para configurar nosso objeto. Um destes métodos é o <em>index(int index). </em>Este método vai definir o ID do botão que queremos clicar. No caso do dialog, o botão “Allow” tem valor 1. Se quiséssemos clicar no “Deny” usaríamos o index = 0.</li><li>Linha 18 e 19: Se o botão “Allow” foi encontrado, efetuamos um clique nele.</li></ul><p>No nosso teste, vamos chamar o método <em>allowPermissionsIfNeeded </em>do <em>PermissionUtils </em>logo depois do clique no telefone. Ficará assim:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/5e051de61a05d237f78d640e449d5e84/href">https://medium.com/media/5e051de61a05d237f78d640e449d5e84/href</a></iframe><p>Tente executar o teste, verifique se ele passa. Se algo deu errado, retome os passos anteriores ou deixe um comentário para que eu possa ajudar.</p><p>Existem outros cenários a serem testados nesta tela, mas o conhecimento necessário para isso já foi abordado neste tutorial. Então, mãos à obra. 😉</p><p>Ao final desta etapa, seu código deve estar parecido com o da branch ‘<a href="https://github.com/heitorcolangelo/EspressoTests/tree/part_6">part_6</a>’.</p><p><a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-7-dee47be84571#.d3ce90tjc">Ir para parte 7 — Dicas finais, TestButler e Robots Pattern&gt;&gt;.</a></p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=d53984b24dbb" width="1" height="1" alt="">
