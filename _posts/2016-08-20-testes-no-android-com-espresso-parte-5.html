---
title: Testes no Android com Espresso — parte 5
date: 2016-08-20 00:00:00 Z
tags:
- espresso
- android
- software-testing
layout: post
---

<h4>Asserções e interações na recycler view</h4><figure><img alt="" src="https://cdn-images-1.medium.com/max/1024/1*99qTbnhUu3jQsGn3eWIgrA.png" /></figure><p>No <a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-4-6107e3e023bc#.e0w4tspge">post anterior</a> aprendemos como mockar as intents do Android. Caso queira iniciar a partir deste post, utilize o branch ‘<a href="https://github.com/heitorcolangelo/EspressoTests/tree/part_2">part_</a>4’ do projeto.</p><h4>Asserções no layout do item da RecyclerView</h4><p>Na nossa MainActivity, o próximo passo é verificar se o layout que definimos para o item da nossa RecyclerView é exibido corretamente. Vamos analisar o <a href="https://github.com/heitorcolangelo/EspressoTests/blob/part_4/app/src/main/res/layout/view_user_item.xml">layout do nosso item</a>.</p><figure><img alt="" src="https://cdn-images-1.medium.com/max/533/1*HVEH26Qsk_S_kpETw2eKmg.png" /><figcaption>view_user_item.xml</figcaption></figure><p>É um layout bem simples:</p><ul><li>Um <em>ImageView</em> com id <em>user_view_image</em>;</li><li>Um <em>TextView</em> com id <em>user_view_name</em>.</li></ul><p>Então, vamos escrever um teste que verifique se estas views estão na tela:</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/96f795fb56963d5e322e4bab37b7e7c2/href">https://medium.com/media/96f795fb56963d5e322e4bab37b7e7c2/href</a></iframe><p>Enfileiramos uma requisição de sucesso, assim, nossa recycler é exibida. Depois, fazemos uma asserção simples nos ids que temos no item da lista. Rode este teste, o resultado deve ser esse:</p><pre>AmbiguousViewMatcherException: &#39;with id: com.example.heitorcolangelo.espressotests:id/user_view_image&#39; <strong>matches multiple views in the hierarchy.</strong></pre><p>O teste não funcionou, e o Espresso está nos dizendo que existem várias views com o id que passamos, afinal de contas, existem vários itens iguais na lista, ou seja, vários ids iguais.</p><p>A maneira que eu costumo resolver este problema pode parecer um pouco preguiçosa, mas tem funcionado muito bem até então. Basta fazer um mock com apenas um item na lista! :)</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/586010b10a5154df2e375d69b3cb5382/href">https://medium.com/media/586010b10a5154df2e375d69b3cb5382/href</a></iframe><p>O teste ficará desta maneira, mudando apenas o <em>body</em> que passamos no MockResponse, para passar o <a href="https://github.com/heitorcolangelo/EspressoTests/blob/part_5/app/src/androidTest/java/com/example/heitorcolangelo/espressotests/mocks/Mocks.java">mock com apenas um item</a>. Rode o teste novamente, ele deve passar. Como temos apenas um item da lista exibido na tela, não temos mais o problema de vários ids iguais. Agora podemos fazer a asserção tranquilamente.</p><p>Claro, não vou ser simplista, isso nem sempre vai ser suficiente. Por exemplo, se você tiver diferentes tipos de layout na sua lista. Vamos, então, fazer o mesmo teste sem usar o “truque” acima.</p><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/9279f81eea5a8a812c66e4f300b6745b/href">https://medium.com/media/9279f81eea5a8a812c66e4f300b6745b/href</a></iframe><p>Utilizamos dois métodos novos:</p><ul><li>allOf: faz um match com todas as condições que passarmos como parâmetro. No caso, passamos <em>withId</em> e <em>hasSibling</em>,</li><li>hasSibling: <em>sibling</em> em inglês quer dizer “irmão”. Este método procura a view que tenha um “irmão” que atenda as condições que passarmos como parâmetro. No caso, passamos <em>withText</em>.</li></ul><p>Na linha 5 falamos para o Espresso: “<em>Verifique se a view que tem o id user_view_image e o irmão com texto “Eddie Dunn” está visível na tela.”</em>. Assim, evitamos que ocorra um <em>AmbiguousViewMatcherException</em>, pois só existe <strong>uma</strong> view que atende as condições acima.</p><p>Neste momento, você pode se perguntar se é correto utilizar diretamente o texto “Eddie Dunn” para fazer a asserção. Afinal de contas, e se o item com o nome “Eddie Dunn” não estiver visível na tela em um primeiro momento? Posso fazer isso sem problemas, pois sei que o primeiro item da lista sempre será “Eddie Dunn”, uma vez que estamos utilizando uma resposta mockada.</p><h4>RecyclerViewActions</h4><p>Até agora, fizemos apenas asserções nos itens da nossa lista. Agora vamos começar a fazer interações, utilizando os métodos da classe RecyclerViewActions. Para isto, adicione esta dependência no seu arquivo build.gradle:</p><pre>androidTestCompile(&quot;com.android.support.test.espresso:espresso-contrib:$espressoVersion&quot;) {<br>  exclude module: &#39;appcompat-v7&#39;<br>  exclude module: &#39;support-v4&#39;<br>  exclude module: &#39;support-annotations&#39;<br>  exclude module: &#39;recyclerview-v7&#39;<br>  exclude module: &#39;design&#39;<br>}</pre><p>Agora, vamos testar o seguinte cenário:</p><ul><li>Ao clicar em um item da lista, deve abrir a UserDetailsActivity.</li></ul><iframe src="" width="0" height="0" frameborder="0" scrolling="no"><a href="https://medium.com/media/4c9aa438d4135ce3ae2e4943b014753e/href">https://medium.com/media/4c9aa438d4135ce3ae2e4943b014753e/href</a></iframe><p>Vamos passar este teste linha-a-linha:</p><ul><li>Linhas 3, 4 e 5: Nada de novo, apenas enfileirando as requests que serão feitas, iniciando a activity e iniciando o serviço de intents.</li><li>Linha 6: Criamos um matcher de intent igual ao que fizemos no teste da <a href="https://gist.github.com/heitorcolangelo/354080abf09bdabd0e9dd0f5a268bc21">LoginActivityTest</a>. A diferença é que passamos mais um matcher como condição, usando o método <em>hasExtraWithKey.</em> Ou seja, além de verificar se a intent que está sendo lançada é para a UserDetailsActivity, verificamos se ela contém um extra, que é o usuário clicado. Por isso, passamos o <em>UserDetailsActivity.CLICKED_USER </em>como parâmetro. Este valor é o mesmo que é atribuído ao <em>key</em> do <em>bundle</em> da nossa <em>intent</em>, quando queremos iniciar a UserDetailsActivity. Para entender melhor, confira o código na <a href="https://github.com/heitorcolangelo/EspressoTests/blob/part_4/app/src/main/java/com/example/heitorcolangelo/espressotests/ui/activity/MainActivity.java">MainActivity</a>.</li><li>Linhas 11 até 14: Nenhuma novidade, apenas definindo o que vamos passar de resultado para a <em>intent</em> que será lançada.</li><li>Linha 16: Usamos o método <a href="https://developer.android.com/reference/android/support/test/espresso/contrib/RecyclerViewActions.html#actionOnItemAtPosition(int, android.support.test.espresso.ViewAction)"><em>actionOnItemAtPosition(int position, ViewAction viewAction)</em></a><em>, </em>da classe <a href="https://developer.android.com/reference/android/support/test/espresso/contrib/RecyclerViewActions.html">RecyclerViewActions</a>, que contém vários outros métodos para interagir com a nossa lista. Não tem nenhum segredo, ele executa a <em>action </em>na <em>position</em> que passamos como parâmetro.</li></ul><p>Execute todos os testes, eles devem passar. Se algo deu errado, retome os passos anteriores ou deixe um comentário para que eu possa ajudar. Ao final desta etapa, seu código devete método estar parecido com o da branch ‘<a href="https://github.com/heitorcolangelo/EspressoTests/tree/part_5">part_5</a>’.</p><p>Vamos partir para os testes na nossa última activity, a UserDetailsActivity.</p><p><a href="https://medium.com/@heitorcolangelo/testes-no-android-com-espresso-parte-6-d53984b24dbb#.b5icilz0m">Ir para Parte 6 — Custom Matchers e Runtime Permissions&gt;&gt;</a></p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=9df6dade067e" width="1" height="1" alt="">
